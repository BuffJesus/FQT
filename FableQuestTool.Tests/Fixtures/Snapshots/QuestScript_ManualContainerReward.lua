-- ManualContainerQuest.lua
-- Generated by Fable Quest Tool (FQT)

Quest = nil

function Init(questObject)
    Quest = questObject
    Quest:Log("ManualContainerQuest: Init phase started.")
    Quest:AddQuestRegion("ManualContainerQuest", "Oakvale")
    Quest:SetQuestWorldMapOffset("ManualContainerQuest", 380, 340)
    Quest:SetStateBool("QuestCompleted", false)
end

function Main(questObject)
    Quest = questObject
    Quest:Log("ManualContainerQuest: Main() started.")

    -- Bind entity scripts
    Quest:AddEntityBinding("ManualChest", "ManualContainerQuest/Entities/ManualChest")
    Quest:FinalizeEntityBindings()

    -- Configure quest card
    Quest:AddQuestCard("OBJECT_QUEST_CARD_GENERIC", "ManualContainerQuest", false, false)

    -- Start quest threads
    Quest:CreateThread("MonitorQuestCompletion", {region="Oakvale"})
end

function OnPersist(questObject, context)
    Quest = questObject
    local QuestCompleted_value = Quest:GetStateBool("QuestCompleted")
    QuestCompleted_value = Quest:PersistTransferBool(context, "QuestCompleted", QuestCompleted_value)
    Quest:SetStateBool("QuestCompleted", QuestCompleted_value)
end

function MonitorQuestCompletion(questObject)
    Quest = questObject
    while true do
        if Quest:GetStateBool("QuestCompleted") then
            Quest:Log("ManualContainerQuest: Quest completed, giving rewards...")

            -- Give rewards

            -- Container reward: Spawn and populate container
            Quest:Log("Attempting to spawn container...")
            local marker = Quest:GetThingWithScriptName("MK_REWARD")
            local containerPos
            if marker ~= nil then
                containerPos = marker:GetPos()
            else
                local hero = Quest:GetHero()
                containerPos = hero:GetPos()
            end
            Quest:Log("Creating container: OBJECT_CHEST at position...")
            local container = Quest:CreateObject("OBJECT_CHEST", containerPos, "ManualChest")
            Quest:Log("CreateObject returned: " .. tostring(container))
            if container ~= nil then
                Quest:Log("Container spawned successfully!")
                Quest:EntitySetTargetable(container, true)
                Quest:Log("Container set as targetable")
                -- Container uses entity script for multi-item rewards on manual open
                Quest:SetThingHasInformation(container, true)
            else
                Quest:Log("WARNING: Failed to spawn container!")
            end

            -- Complete and deactivate quest
            Quest:SetQuestAsCompleted("ManualContainerQuest", true, false, false)
            Quest:DeactivateQuestLater("ManualContainerQuest", 0)
            break
        end
        Quest:Pause(0.5)
        if not Quest:NewScriptFrame() then break end
    end
end
