<Window x:Class="FableQuestTool.Views.EntityBrowserView"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:FableQuestTool.ViewModels"
        xmlns:converters="clr-namespace:FableQuestTool.Converters"
        Title="Entity Browser" Height="600" Width="900"
        WindowStartupLocation="CenterOwner">
    <Window.DataContext>
        <vm:EntityBrowserViewModel />
    </Window.DataContext>
    <Window.Resources>
        <converters:NullToBoolConverter x:Key="NullToBoolConverter" />
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <TabControl Grid.Row="0">
            <TabItem Header="Entities">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="200" />
                    </Grid.RowDefinitions>

                    <!-- Search and Filters -->
                    <Border Grid.Row="0" Background="{DynamicResource BackgroundSecondary}" Padding="12">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="200" />
                                <ColumnDefinition Width="200" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <!-- Search Box -->
                            <TextBox Grid.Row="0" Grid.Column="0"
                                     Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                                     Margin="0,0,8,0"
                                     VerticalContentAlignment="Center"
                                     Height="28">
                                <TextBox.Style>
                                    <Style TargetType="TextBox">
                                        <Setter Property="Foreground" Value="{DynamicResource TextPrimary}" />
                                        <Style.Triggers>
                                            <Trigger Property="IsFocused" Value="True">
                                                <Setter Property="Foreground" Value="{DynamicResource TextPrimary}" />
                                            </Trigger>
                                            <Trigger Property="Text" Value="">
                                                <Setter Property="Background">
                                                    <Setter.Value>
                                                        <VisualBrush AlignmentX="Left" AlignmentY="Center" Stretch="None">
                                                            <VisualBrush.Visual>
                                                                <TextBlock Text="Search by name or type..."
                                                                           Style="{StaticResource MutedText}"
                                                                           Margin="4,0,0,0" />
                                                            </VisualBrush.Visual>
                                                        </VisualBrush>
                                                    </Setter.Value>
                                                </Setter>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBox.Style>
                            </TextBox>

                            <!-- Region Filter -->
                            <ComboBox Grid.Row="0" Grid.Column="1"
                                      ItemsSource="{Binding Regions}"
                                      SelectedItem="{Binding SelectedRegion}"
                                      Margin="0,0,8,0"
                                      Height="28" />

                            <!-- Category Filter -->
                            <ComboBox Grid.Row="0" Grid.Column="2"
                                      ItemsSource="{Binding Categories}"
                                      SelectedItem="{Binding SelectedCategory}"
                                      Margin="0,0,8,0"
                                      Height="28" />

                            <!-- Refresh Button -->
                            <Button Grid.Row="0" Grid.Column="3"
                                    Content="Refresh"
                                    Command="{Binding RefreshCacheCommand}"
                                    Width="80"
                                    Height="28" />

                            <!-- Scriptable Only Checkbox -->
                            <CheckBox Grid.Row="1" Grid.Column="0"
                                      Content="Show only entities with ScriptName (can be used in FSE)"
                                      IsChecked="{Binding ScriptableOnly}"
                                      Margin="0,8,0,0" />
                        </Grid>
                    </Border>

                    <!-- Entity List -->
                    <Border Grid.Row="1" Background="{DynamicResource BackgroundPrimary}" Margin="8">
                        <DataGrid ItemsSource="{Binding FilteredEntities}"
                                  SelectedItem="{Binding SelectedEntity}"
                                  AutoGenerateColumns="False"
                                  IsReadOnly="True"
                                  SelectionMode="Single"
                                  SelectionUnit="FullRow"
                                  RowHeaderWidth="0"
                                  HeadersVisibility="Column"
                                  GridLinesVisibility="None"
                                  Background="{DynamicResource BackgroundSecondary}"
                                  Foreground="{DynamicResource TextPrimary}"
                                  RowBackground="{DynamicResource BackgroundSecondary}"
                                  AlternatingRowBackground="{DynamicResource SurfaceBackground}">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Script Name" Binding="{Binding ScriptName}" Width="200" />
                                <DataGridTextColumn Header="Definition Type" Binding="{Binding DefinitionType}" Width="250" />
                                <DataGridTextColumn Header="Category" Binding="{Binding Category}" Width="120" />
                                <DataGridTextColumn Header="Region" Binding="{Binding RegionName}" Width="150" />
                                <DataGridTextColumn Header="TNG File" Binding="{Binding SourceFile}" Width="*" />
                            </DataGrid.Columns>
                        </DataGrid>
                    </Border>

                    <GridSplitter Grid.Row="2"
                                  Height="6"
                                  HorizontalAlignment="Stretch"
                                  Background="{DynamicResource BorderBrush}"
                                  Margin="8,0"
                                  ShowsPreview="True" />

                    <!-- Entity Details -->
                    <Border Grid.Row="3" Background="{DynamicResource BackgroundSecondary}" Margin="8,0,8,8" Padding="12">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <StackPanel>
                                <TextBlock Text="Entity Details" Style="{StaticResource PanelHeaderText}" Margin="0,0,0,8" />

                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Script Name:" Style="{StaticResource FormLabelText}" Margin="0,4" />
                                    <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SelectedEntity.ScriptName}" Margin="0,4" />

                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Definition Type:" Style="{StaticResource FormLabelText}" Margin="0,4" />
                                    <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding SelectedEntity.DefinitionType}" Margin="0,4" />

                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Thing Type:" Style="{StaticResource FormLabelText}" Margin="0,4" />
                                    <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding SelectedEntity.ThingType}" Margin="0,4" />

                                    <TextBlock Grid.Row="3" Grid.Column="0" Text="Category:" Style="{StaticResource FormLabelText}" Margin="0,4" />
                                    <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding SelectedEntity.Category}" Margin="0,4" />

                                    <TextBlock Grid.Row="4" Grid.Column="0" Text="Position:" Style="{StaticResource FormLabelText}" Margin="0,4" />
                                    <TextBlock Grid.Row="4" Grid.Column="1" Margin="0,4">
                                        <Run Text="{Binding SelectedEntity.PositionX, StringFormat=F2}" />
                                        <Run Text=", " />
                                        <Run Text="{Binding SelectedEntity.PositionY, StringFormat=F2}" />
                                        <Run Text=", " />
                                        <Run Text="{Binding SelectedEntity.PositionZ, StringFormat=F2}" />
                                    </TextBlock>

                                    <TextBlock Grid.Row="5" Grid.Column="0" Text="Region:" Style="{StaticResource FormLabelText}" Margin="0,4" />
                                    <TextBlock Grid.Row="5" Grid.Column="1" Text="{Binding SelectedEntity.RegionName}" Margin="0,4" />

                                    <TextBlock Grid.Row="6" Grid.Column="0" Text="Source File:" Style="{StaticResource FormLabelText}" Margin="0,4" />
                                    <TextBlock Grid.Row="6" Grid.Column="1" Text="{Binding SelectedEntity.SourceFile}" Margin="0,4" />

                                    <TextBlock Grid.Row="7" Grid.Column="0" Text="UID:" Style="{StaticResource FormLabelText}" Margin="0,4" />
                                    <TextBlock Grid.Row="7" Grid.Column="1" Text="{Binding SelectedEntity.Uid}" Margin="0,4" />
                                </Grid>
                            </StackPanel>
                        </ScrollViewer>
                    </Border>
                </Grid>
            </TabItem>

            <TabItem Header="Items">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <Border Grid.Row="0" Background="{DynamicResource BackgroundSecondary}" Padding="12">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <TextBox Grid.Column="0"
                                     Text="{Binding ItemSearchText, UpdateSourceTrigger=PropertyChanged}"
                                     Margin="0,0,8,0"
                                     VerticalContentAlignment="Center"
                                     Height="28">
                                <TextBox.Style>
                                    <Style TargetType="TextBox">
                                        <Setter Property="Foreground" Value="{DynamicResource TextPrimary}" />
                                        <Style.Triggers>
                                            <Trigger Property="IsFocused" Value="True">
                                                <Setter Property="Foreground" Value="{DynamicResource TextPrimary}" />
                                            </Trigger>
                                            <Trigger Property="Text" Value="">
                                                <Setter Property="Background">
                                                    <Setter.Value>
                                                        <VisualBrush AlignmentX="Left" AlignmentY="Center" Stretch="None">
                                                            <VisualBrush.Visual>
                                                                <TextBlock Text="Search items..."
                                                                           Style="{StaticResource MutedText}"
                                                                           Margin="4,0,0,0" />
                                                            </VisualBrush.Visual>
                                                        </VisualBrush>
                                                    </Setter.Value>
                                                </Setter>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBox.Style>
                            </TextBox>

                            <Button Grid.Column="1"
                                    Content="Copy"
                                    Width="80"
                                    Height="28"
                                    Command="{Binding CopySelectedItemCommand}"
                                    IsEnabled="{Binding SelectedItem, Converter={StaticResource NullToBoolConverter}}" />
                        </Grid>
                    </Border>

                    <Border Grid.Row="1" Background="{DynamicResource BackgroundPrimary}" Margin="8">
                        <ListBox ItemsSource="{Binding FilteredItems}"
                                 SelectedItem="{Binding SelectedItem}"
                                 FontFamily="Consolas"
                                 FontSize="12" />
                    </Border>

                    <Border Grid.Row="2" Background="{DynamicResource BackgroundSecondary}" Padding="12,8">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Column="0" Text="{Binding StatusText}" VerticalAlignment="Center" />
                            <Button Grid.Column="1" Content="Close" Width="100" Height="28"
                                    Click="OnCancelClick" />
                        </Grid>
                    </Border>
                </Grid>
            </TabItem>
        </TabControl>

        <!-- Status Bar and Buttons -->
        <Border Grid.Row="1" Background="{DynamicResource BackgroundSecondary}" Padding="12,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0" Text="{Binding StatusText}" VerticalAlignment="Center" />

                <Button Grid.Column="1" Content="Select" Width="100" Height="28" Margin="0,0,8,0"
                        Click="OnSelectClick"
                        IsEnabled="{Binding SelectedEntity, Converter={StaticResource NullToBoolConverter}}" />

                <Button Grid.Column="2" Content="Cancel" Width="100" Height="28"
                        Click="OnCancelClick" />
            </Grid>
        </Border>
    </Grid>
</Window>
