<UserControl x:Class="FableQuestTool.Views.QuestConfigView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:FableQuestTool.Views"
             xmlns:data="clr-namespace:FableQuestTool.Data"
             mc:Ignorable="d"
             DataContext="{Binding DataContext, RelativeSource={RelativeSource AncestorType=Window}}">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibility" />
    </UserControl.Resources>
    <Grid Background="{DynamicResource BackgroundPrimary}">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="220" />
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="340" />
        </Grid.ColumnDefinitions>
        <Border Grid.Column="0" Background="{DynamicResource PanelBackground}">
            <StackPanel Margin="12">
                <TextBlock Text="Quest Setup" FontWeight="SemiBold" Margin="0,0,0,8" />
                <ListBox x:Name="SectionList" SelectionChanged="OnSectionChanged" SelectedIndex="0">
                    <ListBoxItem Content="Basic Info" />
                    <ListBoxItem Content="Quest Card" />
                    <ListBoxItem Content="Regions" />
                    <ListBoxItem Content="Rewards" />
                    <ListBoxItem Content="Optional Challenges"
                                 Visibility="{Binding DataContext.IsAdvancedMode, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource BoolToVisibility}}" />
                    <ListBoxItem Content="States" />
                    <ListBoxItem Content="Background Tasks"
                                 Visibility="{Binding DataContext.IsAdvancedMode, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource BoolToVisibility}}" />
                </ListBox>
            </StackPanel>
        </Border>
        <Border Grid.Column="1" Background="{DynamicResource SurfaceBackground}" Margin="8">
            <ScrollViewer>
                <StackPanel Margin="16" Orientation="Vertical">
                    <GroupBox x:Name="BasicInfoGroup" Header="Basic Info" Margin="0,0,0,12">
                        <StackPanel Margin="12">
                            <TextBlock Text="Quest Name" />
                            <TextBox ToolTip="Internal script name used in Lua code (e.g., 'MyFirstQuest'). Must be unique and contain no spaces."
                                     Text="{Binding Project.Name, UpdateSourceTrigger=PropertyChanged}" />

                            <TextBlock Text="Display Name" Margin="0,12,0,0" />
                            <TextBox ToolTip="Friendly name shown to players in quest log and UI."
                                     Text="{Binding Project.DisplayName, UpdateSourceTrigger=PropertyChanged}" />

                            <TextBlock Text="Quest ID" Margin="0,12,0,0" />
                            <TextBox ToolTip="Unique numeric ID for this quest. Must not conflict with existing quest IDs. Recommend using 50000+ for custom quests."
                                     Text="{Binding Project.Id, UpdateSourceTrigger=PropertyChanged}" />

                            <TextBlock Text="Description" Margin="0,12,0,0" />
                            <TextBox ToolTip="Quest description shown in quest log. Can be multiple lines. Not shown to players."
                                     AcceptsReturn="True" TextWrapping="Wrap" Height="60"
                                     Text="{Binding Project.Description, UpdateSourceTrigger=PropertyChanged}" />

                            <CheckBox Content="Quest Enabled" IsChecked="{Binding Project.IsEnabled, UpdateSourceTrigger=PropertyChanged}" Margin="0,12,0,0"
                                     ToolTip="When unchecked, this quest will not be deployed to FinalAlbion.qst" />
                        </StackPanel>
                    </GroupBox>

                    <GroupBox x:Name="QuestCardGroup" Header="Quest Card" Margin="0,0,0,12">
                        <StackPanel Margin="12">
                            <TextBlock Text="Quest Card Object" />
                            <ComboBox IsEditable="True" IsTextSearchEnabled="True"
                                      ItemsSource="{x:Static data:GameData.QuestCards}"
                                      Text="{Binding Project.QuestCardObject, UpdateSourceTrigger=PropertyChanged}"
                                      ToolTip="The physical quest card item given to the player. Different cards have different icons/appearance in the quest log (Generic, Gold, Silver, etc.)." />

                            <TextBlock Text="Objective Text" Margin="0,12,0,0" />
                            <TextBox Text="{Binding Project.ObjectiveText, UpdateSourceTrigger=PropertyChanged}"
                                     ToolTip="The quest objective shown to players in their quest log. Describes what they need to do to complete the quest." />

                            <StackPanel Orientation="Horizontal" Margin="0,12,0,0">
                                <StackPanel Width="180">
                                    <TextBlock Text="Objective Region 1" />
                                    <ComboBox IsEditable="True" IsTextSearchEnabled="True"
                                              ItemsSource="{x:Static data:GameData.Regions}"
                                              Text="{Binding Project.ObjectiveRegion1, UpdateSourceTrigger=PropertyChanged}"
                                              ToolTip="Primary region where quest objectives are located. Used to show golden trail/breadcrumb path to guide players." />
                                </StackPanel>
                                <StackPanel Width="180" Margin="8,0,0,0">
                                    <TextBlock Text="Objective Region 2" />
                                    <ComboBox IsEditable="True" IsTextSearchEnabled="True"
                                              ItemsSource="{x:Static data:GameData.Regions}"
                                              Text="{Binding Project.ObjectiveRegion2, UpdateSourceTrigger=PropertyChanged}"
                                              ToolTip="Optional secondary region for quests spanning multiple areas. Leave blank if quest is in one region only." />
                                </StackPanel>
                            </StackPanel>

                            <!-- World Map Offset with Auto-Calculate Button -->
                            <StackPanel x:Name="MapOffsetsPanel" Orientation="Horizontal" Margin="0,12,0,0">
                                <StackPanel Width="100">
                                    <TextBlock Text="World Map X" />
                                    <TextBox Text="{Binding Project.WorldMapOffsetX, UpdateSourceTrigger=PropertyChanged}"
                                             ToolTip="Horizontal pixel offset for the quest marker on the world map. Set to 0 for auto-calculation." />
                                </StackPanel>
                                <StackPanel Width="100" Margin="8,0,0,0">
                                    <TextBlock Text="World Map Y" />
                                    <TextBox Text="{Binding Project.WorldMapOffsetY, UpdateSourceTrigger=PropertyChanged}"
                                             ToolTip="Vertical pixel offset for the quest marker on the world map. Set to 0 for auto-calculation." />
                                </StackPanel>
                                <Button Content="Auto" 
                                        Width="50" 
                                        Margin="8,14,0,0"
                                        VerticalAlignment="Top"
                                        Click="OnAutoCalculateMapOffset"
                                        ToolTip="Auto-calculate map offset based on primary region. Uses region center coordinates." />
                            </StackPanel>
                            <TextBlock Text="Leave at 0,0 to auto-calculate from region" 
                                       FontSize="10" 
                                       Opacity="0.6" 
                                       Margin="0,4,0,0" />

                            <StackPanel Orientation="Horizontal" Margin="0,12,0,0">
                                <CheckBox Content="Use Start Screen" IsChecked="{Binding Project.UseQuestStartScreen}" Margin="0,0,12,0"
                                          ToolTip="Shows a fancy quest introduction screen when the quest begins, displaying quest name, description, and rewards preview. Typically used for major quests." />
                                <CheckBox Content="Story Quest" IsChecked="{Binding Project.IsStoryQuest}" Margin="0,0,12,0"
                                          ToolTip="Marks this as a main storyline quest. Affects display order in quest log (story quests appear at top)." />
                                <CheckBox Content="Gold Quest" IsChecked="{Binding Project.IsGoldQuest}"
                                          ToolTip="Marks as a Gold difficulty quest (harder challenges, better rewards). Shows a gold-colored quest card icon." />
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                <CheckBox Content="Give Quest Card Directly" IsChecked="{Binding Project.GiveCardDirectly}" Margin="0,0,12,0"
                                          ToolTip="If checked, player receives the quest card automatically when quest activates. If unchecked, card must be obtained through scripting/NPCs/pickups." />
                                <CheckBox Content="Guild Quest (Quest Table)" IsChecked="{Binding Project.IsGuildQuest}"
                                          ToolTip="If checked, quest appears on Heroes' Guild quest table where players can read details and accept it. If unchecked, quest activates through scripting (cutscenes, NPCs, etc.)." />
                            </StackPanel>
                        </StackPanel>
                    </GroupBox>

                    <GroupBox x:Name="RegionsGroup" Header="Regions" Margin="0,0,0,12">
                        <StackPanel Margin="12">
                            <StackPanel Orientation="Horizontal">
                                <ComboBox x:Name="RegionInput" Width="200" Margin="0,0,8,0" IsEditable="True" IsTextSearchEnabled="True"
                                          ItemsSource="{x:Static data:GameData.Regions}" />
                                <Button Content="Add" Width="80" Click="OnAddRegion" />
                                <Button Content="Remove" Width="80" Margin="8,0,0,0" Click="OnRemoveRegion" />
                            </StackPanel>
                            <ListBox x:Name="RegionsList" ItemsSource="{Binding Project.Regions}" Height="120" Margin="0,8,0,0" />
                        </StackPanel>
                    </GroupBox>

                    <GroupBox x:Name="RewardsGroup" Header="Rewards" Margin="0,0,0,12">
                        <StackPanel Margin="12">
                            <UniformGrid Columns="4">
                                <StackPanel>
                                    <TextBlock Text="Gold" />
                                    <TextBox Text="{Binding Project.Rewards.Gold, UpdateSourceTrigger=PropertyChanged}" />
                                </StackPanel>
                                <StackPanel>
                                    <TextBlock Text="Experience" />
                                    <TextBox Text="{Binding Project.Rewards.Experience, UpdateSourceTrigger=PropertyChanged}" />
                                </StackPanel>
                                <StackPanel>
                                    <TextBlock Text="Renown" />
                                    <TextBox Text="{Binding Project.Rewards.Renown, UpdateSourceTrigger=PropertyChanged}" />
                                </StackPanel>
                                <StackPanel>
                                    <TextBlock Text="Morality" />
                                    <TextBox Text="{Binding Project.Rewards.Morality, UpdateSourceTrigger=PropertyChanged}" />
                                </StackPanel>
                            </UniformGrid>

                            <TextBlock Text="Reward Items" Margin="0,12,0,0" />
                            <StackPanel Orientation="Horizontal">
                                <ComboBox x:Name="RewardItemInput" Width="200" Margin="0,0,8,0" IsEditable="True" IsTextSearchEnabled="True"
                                          ItemsSource="{x:Static data:GameData.Objects}" />
                                <Button Content="Add" Width="80" Click="OnAddRewardItem" />
                                <Button Content="Update" Width="80" Margin="8,0,0,0" Click="OnUpdateRewardItem" />
                                <Button Content="Remove" Width="80" Margin="8,0,0,0" Click="OnRemoveRewardItem" />
                            </StackPanel>
                            <ListBox x:Name="RewardItemsList" ItemsSource="{Binding Project.Rewards.Items}" Height="80" Margin="0,8,0,0" SelectionChanged="OnRewardItemSelected" />

                            <TextBlock Text="Reward Abilities" Margin="0,12,0,0" />
                            <StackPanel Orientation="Horizontal">
                                <ComboBox x:Name="RewardAbilityInput" Width="200" Margin="0,0,8,0" IsEditable="True" IsTextSearchEnabled="True"
                                          ItemsSource="{x:Static data:GameData.Abilities}" />
                                <Button Content="Add" Width="80" Click="OnAddRewardAbility" />
                                <Button Content="Update" Width="80" Margin="8,0,0,0" Click="OnUpdateRewardAbility" />
                                <Button Content="Remove" Width="80" Margin="8,0,0,0" Click="OnRemoveRewardAbility" />
                            </StackPanel>
                            <ListBox x:Name="RewardAbilitiesList" ItemsSource="{Binding Project.Rewards.Abilities}" Height="80" Margin="0,8,0,0" SelectionChanged="OnRewardAbilitySelected" />
                        </StackPanel>
                    </GroupBox>

                    <GroupBox x:Name="BoastsGroup" Header="Optional Challenges (Boasts)" Margin="0,0,0,12">
                        <StackPanel Margin="12">
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                <StackPanel Width="80">
                                    <TextBlock Text="Boast ID" />
                                    <TextBox x:Name="BoastIdInput" />
                                </StackPanel>
                                <StackPanel Width="180" Margin="8,0,0,0">
                                    <TextBlock Text="Boast Text" />
                                    <TextBox x:Name="BoastTextInput" />
                                </StackPanel>
                                <StackPanel Width="80" Margin="8,0,0,0">
                                    <TextBlock Text="Renown" />
                                    <TextBox x:Name="BoastRenownInput" Text="0" />
                                </StackPanel>
                                <StackPanel Width="80" Margin="8,0,0,0">
                                    <TextBlock Text="Gold" />
                                    <TextBox x:Name="BoastGoldInput" Text="0" />
                                </StackPanel>
                                <StackPanel Margin="8,18,0,0">
                                    <CheckBox x:Name="IsBoastCheck" Content="Is Boast" IsChecked="True" />
                                </StackPanel>
                                <Button Content="Add" Width="60" Margin="8,18,0,0" Click="OnAddBoast" />
                                <Button Content="Remove" Width="70" Margin="8,18,0,0" Click="OnRemoveBoast" />
                            </StackPanel>

                            <ListBox x:Name="BoastsList" ItemsSource="{Binding Project.Boasts}" Height="120" Margin="0,8,0,0" SelectionChanged="OnBoastSelected">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding BoastId}" Width="80" />
                                            <TextBlock Text="{Binding Text}" Width="220" />
                                            <TextBlock Text="{Binding RenownReward}" Width="80" />
                                            <TextBlock Text="{Binding GoldReward}" Width="80" />
                                            <TextBlock Text="{Binding IsBoast}" Width="60" />
                                        </StackPanel>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </StackPanel>
                    </GroupBox>

                    <GroupBox x:Name="StatesGroup" Header="States" Margin="0,0,0,12">
                        <StackPanel Margin="12">
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                <StackPanel Width="160">
                                    <TextBlock Text="Name" />
                                    <TextBox x:Name="StateNameInput" />
                                </StackPanel>
                                <StackPanel Width="110" Margin="8,0,0,0">
                                    <TextBlock Text="Type" />
                                    <ComboBox x:Name="StateTypeInput" SelectedIndex="0">
                                        <ComboBoxItem Content="bool" />
                                        <ComboBoxItem Content="int" />
                                        <ComboBoxItem Content="string" />
                                    </ComboBox>
                                </StackPanel>
                                <StackPanel Width="140" Margin="8,0,0,0">
                                    <TextBlock Text="Default" />
                                    <TextBox x:Name="StateDefaultInput" />
                                </StackPanel>
                                <StackPanel Margin="8,18,0,0">
                                    <CheckBox x:Name="StatePersistInput" Content="Persist" IsChecked="True" />
                                </StackPanel>
                                <Button Content="Add" Width="70" Margin="8,18,0,0" Click="OnAddState" />
                                <Button Content="Remove" Width="80" Margin="8,18,0,0" Click="OnRemoveState" />
                            </StackPanel>

                            <ListBox x:Name="StatesList" ItemsSource="{Binding Project.States}" Height="140">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding Name}" Width="160" />
                                            <TextBlock Text="{Binding Type}" Width="80" />
                                            <TextBlock Text="{Binding Persist}" Width="60" />
                                        </StackPanel>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </StackPanel>
                    </GroupBox>

                    <GroupBox x:Name="ThreadsGroup" Header="Background Tasks">
                        <StackPanel Margin="12">
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                <StackPanel Width="160">
                                    <TextBlock Text="Function" />
                                    <TextBox x:Name="ThreadFunctionInput" />
                                </StackPanel>
                                <StackPanel Width="160" Margin="8,0,0,0">
                                    <TextBlock Text="Region" />
                                    <TextBox x:Name="ThreadRegionInput" />
                                </StackPanel>
                                <StackPanel Width="220" Margin="8,0,0,0">
                                    <TextBlock Text="Description" />
                                    <TextBox x:Name="ThreadDescriptionInput" />
                                </StackPanel>
                                <Button Content="Add" Width="70" Margin="8,18,0,0" Click="OnAddThread" />
                                <Button Content="Update" Width="80" Margin="8,18,0,0" Click="OnUpdateThread" />
                                <Button Content="Remove" Width="80" Margin="8,18,0,0" Click="OnRemoveThread" />
                            </StackPanel>

                            <ListBox x:Name="ThreadsList" ItemsSource="{Binding Project.Threads}" Height="120" SelectionChanged="OnThreadSelected">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding FunctionName}" Width="160" />
                                            <TextBlock Text="{Binding Region}" Width="160" />
                                            <TextBlock Text="{Binding Description}" Width="220" />
                                        </StackPanel>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </StackPanel>
                    </GroupBox>
                </StackPanel>
            </ScrollViewer>
        </Border>
        <Border Grid.Column="2" Background="{DynamicResource PanelBackground}">
            <StackPanel Margin="12">
                <TextBlock Text="Quest Script Preview" FontWeight="SemiBold" Margin="0,0,0,8" />
                <TextBox x:Name="PreviewText"
                         IsReadOnly="True"
                         AcceptsReturn="True"
                         TextWrapping="Wrap"
                         VerticalScrollBarVisibility="Auto"
                         HorizontalScrollBarVisibility="Auto"
                         Height="700" />
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
